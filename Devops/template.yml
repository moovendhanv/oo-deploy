AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'AWS Batch with Spot Instances and Retry Configuration - SAM Template'

Parameters:
  VpcId:
    Type: String
    Description: VPC ID for Batch compute environment
    Default: ''
  
  SubnetIds:
    Type: CommaDelimitedList
    Description: Comma-separated list of Subnet IDs
    Default: ''
  
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment name

  MaxRetryAttempts:
    Type: Number
    Default: 3
    MinValue: 1
    MaxValue: 10
    Description: Maximum number of retry attempts for failed jobs

  ResourcePrefix:
    Type: String
    Description: Prefix for resource names

  ResourceType:
    Type: String
    Description: Type of resource

  RedisEndpoint:
    Type: String
    Description: Redis endpoint

  TimeoutDurationSeconds:
    Type: Number
    Default: 28800
    MinValue: 60
    MaxValue: 86400
    Description: Timeout duration in seconds

  # Compute Environment Parameters
  BidPercentage:
    Type: Number
    Default: 100
    MinValue: 0
    MaxValue: 100 
    Description: Maximum percentage of On-Demand price to bid for Spot instances

  MinvCpus:
    Type: Number
    Default: 0
    MinValue: 0
    Description: Minimum number of vCPUs in the compute environment

  MaxvCpus:
    Type: Number
    Default: 4
    MinValue: 0
    Description: Maximum number of vCPUs in the compute environment

  DesiredvCpus:
    Type: Number
    Default: 0
    MinValue: 0
    Description: Desired number of vCPUs in the compute environment

  # Container Parameters
  JobVcpus:
    Type: Number
    Default: 1
    MinValue: 1
    Description: Number of vCPUs for the job container

  JobMemory:
    Type: Number
    Default: 512
    MinValue: 128
    Description: Memory (in MiB) for the job container

Conditions:
  HasVpcConfig: !Not [!Equals [!Ref VpcId, '']]

Resources:
  # IAM Role for Batch Service
  BatchServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: batch.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for ECS Task Execution
  EcsTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # IAM Role for EC2 Instances
  EcsInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
      Tags:
        - Key: Environment
          Value: !Ref Environment

  EcsInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "${ResourcePrefix}-${Environment}-${ResourceType}-ecs-instance-profile"
      Roles:
        - !Ref EcsInstanceRole

  # Security Group
  BatchSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: HasVpcConfig
    Properties:
      GroupDescription: !Sub 'Security group for Batch ${Environment}'
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub 'batch-spot-sg-${Environment}'
        - Key: Environment
          Value: !Ref Environment

  # Spot Fleet Role
  SpotFleetRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: spotfleet.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2SpotFleetTaggingRole
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # CloudWatch Log Group
  # BatchLogGroup:
  #   Type: AWS::Logs::LogGroup
  #   Properties:
  #     LogGroupName: !Sub '/aws/batch/${ResourcePrefix}-${Environment}-${ResourceType}-logs'
  #     RetentionInDays: 60
  #   DeletionPolicy: Delete
  #   UpdateReplacePolicy: Delete

  # Batch Compute Environment with SPOT
  BatchComputeEnvironmentSpot:
    Type: AWS::Batch::ComputeEnvironment
    Properties:
      ComputeEnvironmentName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-env'
      Type: MANAGED
      State: ENABLED
      ServiceRole: !GetAtt BatchServiceRole.Arn
      ComputeResources:
        Type: SPOT
        AllocationStrategy: SPOT_CAPACITY_OPTIMIZED
        BidPercentage: !Ref BidPercentage
        MinvCpus: !Ref MinvCpus
        MaxvCpus: !Ref MaxvCpus
        DesiredvCpus: !Ref DesiredvCpus
        InstanceTypes:
          - m5.large
          - m5.xlarge
        Subnets: !If
          - HasVpcConfig
          - !Ref SubnetIds
          - !Ref AWS::NoValue
        SecurityGroupIds: !If
          - HasVpcConfig
          - [!Ref BatchSecurityGroup]
          - !Ref AWS::NoValue
        InstanceRole: !GetAtt EcsInstanceProfile.Arn
        SpotIamFleetRole: !GetAtt SpotFleetRole.Arn
        Tags:
          Name: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}'
          Environment: !Ref Environment

  # Job Queue
  BatchJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      JobQueueName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-queue'
      State: ENABLED
      Priority: 1
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Ref BatchComputeEnvironmentSpot

  # Job Definition with Retry Strategy
  BatchJobDefinition:
    Type: AWS::Batch::JobDefinition
    Properties:
      JobDefinitionName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-job'
      Type: container
      PlatformCapabilities:
        - EC2
      # RETRY STRATEGY CONFIGURATION
      RetryStrategy:
        Attempts: !Ref MaxRetryAttempts
      # TIMEOUT CONFIGURATION
      Timeout:
        AttemptDurationSeconds: !Ref TimeoutDurationSeconds
      ContainerProperties:
        Image: !Sub "${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/webhook-sender:latest"
        Vcpus: !Ref JobVcpus
        Memory: !Ref JobMemory
        Command:
          - node
          - index.mjs
        Environment:
          - Name: ENVIRONMENT
            Value: !Ref Environment
          - Name: REDIS_ENDPOINT
            Value: !Ref RedisEndpoint
          - Name: USER_ID
            Value: "sample-user"
          - Name: PAYLOAD
            Value: "{}"
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Sub '/batch/${ResourcePrefix}-${Environment}-${ResourceType}-logs'
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: batch-job
        ExecutionRoleArn: !GetAtt EcsTaskExecutionRole.Arn


Outputs:
  ComputeEnvironmentName:
    Description: Batch Compute Environment Name
    Value: !Ref BatchComputeEnvironmentSpot
    Export:
      Name: !Sub '${AWS::StackName}-ComputeEnv'

  JobQueueName:
    Description: Batch Job Queue Name
    Value: !Ref BatchJobQueue
    Export:
      Name: !Sub '${AWS::StackName}-JobQueue'

  JobDefinitionArn:
    Description: Job Definition ARN
    Value: !Ref BatchJobDefinition
    Export:
      Name: !Sub '${AWS::StackName}-JobDef'

  # LogGroupName:
  #   Description: CloudWatch Log Group Name
  #   Value: !Ref BatchLogGroup
  #   Export:
  #     Name: !Sub '${AWS::StackName}-LogGroup'

  SubmitJobCommand:
    Description: Command to submit a test job
    Value: !Sub |
      aws batch submit-job --job-name test-$(date +%s) --job-queue ${BatchJobQueue} --job-definition ${BatchJobDefinition}
  
  SubmitJobWithCustomRetry:
    Description: Command to submit job with custom retry override
    Value: !Sub |
      aws batch submit-job \
        --job-name test-$(date +%s) \
        --job-queue ${BatchJobQueue} \
        --job-definition ${BatchJobDefinition} \
        --retry-strategy attempts=5