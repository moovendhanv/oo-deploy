AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'AWS Batch Infrastructure with proper resource ordering'

Parameters:
  VpcId:
    Type: String
    Description: VPC ID for Batch compute environment
    Default: ''
  
  SubnetId1:
    Type: String
    Description: Subnet ID 1
    Default: ''
  
  SubnetId2:
    Type: String
    Description: Subnet ID 2
    Default: ''
  
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment name

  MaxRetryAttempts:
    Type: Number
    Default: 3
    MinValue: 1
    MaxValue: 10
    Description: Maximum number of retry attempts for failed jobs

  ResourcePrefix:
    Type: String
    Description: Prefix for resource names

  ResourceType:
    Type: String
    Description: Type of resource

  RedisEndpoint:
    Type: String
    Description: Redis endpoint

  TimeoutDurationSeconds:
    Type: Number
    Default: 28800
    MinValue: 60
    MaxValue: 86400
    Description: Timeout duration in seconds

  BidPercentage:
    Type: Number
    Default: 100
    MinValue: 0
    MaxValue: 100 
    Description: Spot bid percentage

  MinvCpus:
    Type: Number
    Default: 0
    MinValue: 0

  MaxvCpus:
    Type: Number
    Default: 4
    MinValue: 0

  DesiredvCpus:
    Type: Number
    Default: 0
    MinValue: 0

  JobVcpus:
    Type: Number
    Default: 1
    MinValue: 1

  JobMemory:
    Type: Number
    Default: 512
    MinValue: 128

  ImageUri:
    Type: String
    Description: Container image URI

Conditions:
  HasVpcConfig: !Not [!Equals [!Ref VpcId, '']]

Resources:

  # ==========================================
  # STEP 1: CloudWatch Log Group (No dependencies)
  # ==========================================
  BatchLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/batch/${ResourcePrefix}-${Environment}-${ResourceType}'
      RetentionInDays: 7

  # ==========================================
  # STEP 2: IAM Roles (No dependencies)
  # ==========================================
  BatchServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-batch-service-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: batch.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSBatchServiceRole
      Tags:
        - Key: Environment
          Value: !Ref Environment

  EcsTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-ecs-task-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
      Tags:
        - Key: Environment
          Value: !Ref Environment

  EcsInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-ecs-instance-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2ContainerServiceforEC2Role
      Tags:
        - Key: Environment
          Value: !Ref Environment

  SpotFleetRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-spot-fleet-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: spotfleet.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2SpotFleetTaggingRole
      Tags:
        - Key: Environment
          Value: !Ref Environment

  # ==========================================
  # STEP 3: Instance Profile (Depends on EcsInstanceRole)
  # ==========================================
  EcsInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    DependsOn: EcsInstanceRole
    Properties:
      InstanceProfileName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-instance-profile'
      Roles:
        - !Ref EcsInstanceRole

  # ==========================================
  # STEP 4: Security Group (Depends on VPC)
  # ==========================================
  BatchSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: HasVpcConfig
    Properties:
      GroupName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-batch-sg'
      GroupDescription: !Sub 'Security group for Batch ${Environment}'
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub '${ResourcePrefix}-${Environment}-batch-sg'
        - Key: Environment
          Value: !Ref Environment

  # ==========================================
  # STEP 5: Batch job
  # ==========================================

  # Batch Compute Environment
  BatchComputeEnvironmentSpot:
    Type: AWS::Batch::ComputeEnvironment
    DependsOn:
      - BatchServiceRole
      - SpotFleetRole
      - EcsInstanceProfile
    Properties:
      ComputeEnvironmentName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-env'
      Type: MANAGED
      State: ENABLED
      ServiceRole: !GetAtt BatchServiceRole.Arn
      ComputeResources:
        Type: SPOT
        AllocationStrategy: SPOT_CAPACITY_OPTIMIZED
        BidPercentage: !Ref BidPercentage
        MinvCpus: !Ref MinvCpus
        MaxvCpus: !Ref MaxvCpus
        DesiredvCpus: !Ref DesiredvCpus
        InstanceTypes:
          - optimal
        Subnets: !If
          - HasVpcConfig
          - 
            - !Ref SubnetId1
            - !Ref SubnetId2
          - !Ref AWS::NoValue
        SecurityGroupIds: !If
          - HasVpcConfig
          - [!Ref BatchSecurityGroup]
          - !Ref AWS::NoValue
        InstanceRole: !GetAtt EcsInstanceProfile.Arn
        SpotIamFleetRole: !GetAtt SpotFleetRole.Arn
        Tags:
          Name: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}'
          Environment: !Ref Environment

  # Batch Job Queue
  BatchJobQueue:
    Type: AWS::Batch::JobQueue
    Properties:
      JobQueueName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-queue'
      State: ENABLED
      Priority: 1
      ComputeEnvironmentOrder:
        - Order: 1
          ComputeEnvironment: !Ref BatchComputeEnvironmentSpot

  BatchJobDefinition:
    Type: AWS::Batch::JobDefinition
    DependsOn:
      - EcsTaskExecutionRole
      - BatchLogGroup
    Properties:
      JobDefinitionName: !Sub '${ResourcePrefix}-${Environment}-${ResourceType}-jobdef'
      Type: container
      PlatformCapabilities:
        - EC2
      RetryStrategy:
        Attempts: !Ref MaxRetryAttempts
      Timeout:
        AttemptDurationSeconds: !Ref TimeoutDurationSeconds
      ContainerProperties:
        Image: !Ref ImageUri
        Vcpus: !Ref JobVcpus
        Memory: !Ref JobMemory
        Command:
          - node
          - index.mjs
        Environment:
          - Name: ENVIRONMENT
            Value: !Ref Environment
          - Name: REDIS_ENDPOINT
            Value: !Ref RedisEndpoint
          - Name: USER_ID
            Value: "sample-user"
          - Name: PAYLOAD
            Value: "{}"
        LogConfiguration:
          LogDriver: awslogs
          Options:
            awslogs-group: !Ref BatchLogGroup
            awslogs-region: !Ref AWS::Region
            awslogs-stream-prefix: batch-job
        ExecutionRoleArn: !GetAtt EcsTaskExecutionRole.Arn

Outputs:
  BatchServiceRoleArn:
    Description: Batch Service Role ARN
    Value: !GetAtt BatchServiceRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-BatchServiceRoleArn'

  EcsTaskExecutionRoleArn:
    Description: ECS Task Execution Role ARN
    Value: !GetAtt EcsTaskExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EcsTaskExecutionRoleArn'

  EcsInstanceRoleArn:
    Description: ECS Instance Role ARN
    Value: !GetAtt EcsInstanceRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EcsInstanceRoleArn'

  EcsInstanceProfileArn:
    Description: ECS Instance Profile ARN
    Value: !GetAtt EcsInstanceProfile.Arn
    Export:
      Name: !Sub '${AWS::StackName}-EcsInstanceProfileArn'

  SpotFleetRoleArn:
    Description: Spot Fleet Role ARN
    Value: !GetAtt SpotFleetRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-SpotFleetRoleArn'

  BatchSecurityGroupId:
    Description: Batch Security Group ID
    Value: !If [HasVpcConfig, !Ref BatchSecurityGroup, '']
    Export:
      Name: !Sub '${AWS::StackName}-SecurityGroupId'

  LogGroupName:
    Description: CloudWatch Log Group Name
    Value: !Ref BatchLogGroup
    Export:
      Name: !Sub '${AWS::StackName}-LogGroupName'

  JobDefinitionArn:
    Description: Batch Job Definition ARN
    Value: !Ref BatchJobDefinition
    Export:
      Name: !Sub '${AWS::StackName}-JobDefinitionArn'